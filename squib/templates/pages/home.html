{% extends "base.html" %}
{% block title %} Home {% endblock %}
{% block content %}
<!-- <h1>Hello, Welcome to Squib</h1> -->
<div class="row">
    <div class="col-md-4 col-10 mx-auto">
        <form action="/tweet-create" method="post" class="my-4" id="tweet-create-form">
            {% csrf_token %}
            <input type="hidden" name="next" value="/" />
            <textarea class="form-control" name="content" placeholder="How was the day!!!"></textarea>
            <button class="btn btn-primary mt-2" type="submit">Tweet</button>
        </form>
    </div>
</div>

<div class="row" id="tweets">
    <!-- here your tweet  -->
</div>
<script>
    const tweetsEl = document.getElementById("tweets")
    const tweetCreateFormEl = document.getElementById("tweet-create-form")

    function handleTweetsCreateForm(event){
        event.preventDefault();
        const myForm = event.target ;
        const myFormData = new FormData(myForm)
        const url = myForm.getAttribute("action") ;
        const method = myForm.getAttribute("method") ;
        // console.log(url, method);
        const xhr = new XMLHttpRequest()
        xhr.open(method, url)
        xhr.setRequestHeader("HTTP_X_REQUESTED_WITH", 'XMLHttpRequest')
        xhr.setRequestHeader("X-Requested-With", 'XMLHttpRequest')
        xhr.onload = function(){
            const serverResponse = xhr.response
            console.log(xhr.status, serverResponse)
            loadTweets(tweetsEl)
        }
        xhr.send(myFormData)
    }

    tweetCreateFormEl.addEventListener("submit", handleTweetsCreateForm);

    function handleLikes(tweetId, currentLike) {
        console.log(tweetId, currentLike)
        currentLike++
        return
    }

    function likeBtn(tweet) {
        return "<button class='btn btn-primary' onclick=handleLikes(" + tweet.id + "," + tweet.likes + ")>Like</button>"
    }

    function showContent(tweet) {
        let content = "<div class='col-12 col-md-10 mx-auto mb-4 border rounded py-3' id='tweet-" + tweet.id + "'><p >" + tweet.content +
            "</p><div class='btn-group'>"
            + likeBtn(tweet) +
            "</div></div>"
        return content
    }

    function loadTweets(tweetsElement) {
        const xhr = new XMLHttpRequest()
        const method = 'GET'
        const url = '/tweets'
        const responseType = 'json'
        xhr.responseType = responseType
        xhr.open(method, url)
        xhr.onload = function () {
            const serverResponse = xhr.response
            var listedItems = serverResponse.response
            let finalContent = ""
            // tweetsElement.innerHTML = listedItems  
            for (item in listedItems) {
                finalContent += showContent(listedItems[item])
            }
            // console.log(listedItems)
            // console.log(finalContent)
            tweetsElement.innerHTML = finalContent
        }
        xhr.send()
    }

    loadTweets(tweetsEl)


</script>
{% endblock %}